{% extends "postlogin/base.html" %} {% load static %} {% block content %}

<link rel="stylesheet" type="text/css" href="{% static 'postlogin/css/tracker.css'%}" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>

<!--Food Saving Methods-->
<div class="container p-2">
  <p><b>Welcome back, {{ request.session.FirstName }}</b></p>
  <div class="card">
    <div class="card-header">
      <h3>Enter tracker data:</h3>
    </div>
    <div class="card-body">
      <div id="form-wrapper">
        <form class="tracker-data-entry" action="" method="post" id="tracker">
          {% csrf_token %}
          <div class="row">
            <div class="col-md-auto">
              <label for="description">Description</label><br />
              <input type="text" class="form-control" id="description" name="description" placeholder="Description"
                style="width: 10em" />
            </div>
            <!--
                        <div class="col-md-auto">
                            <label for="category">Category</label><br>
                            <input type="text" class="form-control" id="FPcategory" name="category" value="Fresh Produce"
                                style="width: 10em;" readonly>
                        </div>
                        -->
            <div class="col-md-auto">
              <label for="category">Category</label><br />
              <select class="form-select" id="category" name="category">
                <option>Fresh Produce</option>
                <option>Metric #2</option>
                <option>Metric #3</option>
                <option>Metric #4</option>
                <option>Metric #5</option>
              </select>
            </div>
            <div class="col-md-auto">
              <label for="quantity">Quantity</label><br />
              <input type="text" class="form-control" id="quantity" name="quantity" style="width: 10em" />
            </div>
            <div class="col-md-auto">
              <label for="qunits">Units</label><br />
              <select class="form-select" id="qunits" name="qunits">
                <option>lbs</option>
                <option>kgs</option>
              </select>
            </div>
            <div class="col-auto">
              <div class="row">
                <div class="col-auto">
                  <label for="amount">Amount</label>
                </div>
              </div>
              <div class="row pb-2">
                <div class="col-auto">
                  <input type="number" class="form-control" id="clients" name="clients" value="0" min="0"
                    onkeyup="calculateLandfill(); calculatePercent()" style="width: 10em" />
                </div>
              </div>
              <div class="row pb-2">
                <div class="col-auto">
                  <input type="number" class="form-control" id="animalFeed" name="animalFeed" value="0" min="0"
                    onkeyup="calculateLandfill(); calculatePercent()" style="width: 10em" />
                </div>
              </div>
              <div class="row pb-2">
                <div class="col-auto">
                  <input type="number" class="form-control" id="compost" name="compost" value="0" min="0"
                    onkeyup="calculateLandfill(); calculatePercent()" style="width: 10em" />
                </div>
              </div>
              <div class="row pb-2">
                <div class="col-auto">
                  <input type="number" class="form-control" id="partnet" name="partnet" value="0" min="0"
                    onkeyup="calculateLandfill(); calculatePercent()" style="width: 10em" />
                </div>
              </div>
              <div class="row pb-2">
                <div class="col-auto">
                  <input type="number" class="form-control" id="landfill" name="landfill" value="0" min="0"
                    style="width: 10em" />
                </div>
              </div>
            </div>
            <div class="col">
              <div class="row">
                <div class="col-auto">
                  <label for="percent">% Diverted to:</label><br />
                </div>
              </div>
              <div class="row pb-2">
                <div class="col-auto">
                  <input type="number" class="form-control" id="percentclients" name="percentclients"
                    style="width: 4.5em" value="0" min="0" max="100" onload="calculateLandfillPercent()" readonly />
                </div>
                <div class="col d-flex align-items-center">Clients</div>
              </div>
              <div class="row pb-2">
                <div class="col-auto">
                  <input type="number" class="form-control" id="percentanimalfeed" name="percentanimalfeed"
                    style="width: 4.5em" value="0" min="0" max="100" onload="calculateLandfillPercent()" readonly />
                </div>
                <div class="col d-flex align-items-center">Animal Feed</div>
              </div>
              <div class="row pb-2">
                <div class="col-auto">
                  <input type="number" class="form-control" id="percentcompost/fert" name="percentcompost/fert"
                    style="width: 4.5em" value="0" min="0" max="100" onload="calculateLandfillPercent()" readonly />
                </div>
                <div class="col d-flex align-items-center">
                  Compost/Fertilizer
                </div>
              </div>
              <div class="row pb-2">
                <div class="col-auto">
                  <input type="number" class="form-control" id="percentpartnet" name="percentpartnet"
                    style="width: 4.5em" value="0" min="0" max="100" onload="calculateLandfillPercent()" readonly />
                </div>
                <div class="col d-flex align-items-center">Partner Network</div>
              </div>
              <div class="row pb-2">
                <div class="col-auto">
                  <input type="number" class="form-control" id="percentlandfill" name="percentlandfill"
                    style="width: 4.5em" value="100" readonly />
                </div>
                <div class="col d-flex align-items-center">Landfill</div>
              </div>
            </div>
          </div>
          <div class="row p-2">
            <div class="d-flex justify-content-start">
              <button class="save btn btn-outline-success" id="submit" type="submit">
                Save
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <br />

  <br />

  <section id="section">
    <div class="card">
      <div class="card-header">
        <h3>Database</h3>
        <button type="button" class="btn btn-outline-success" onclick="exportTableToCSV('data.csv')">
          Export CSV
        </button>
      </div>
      <div class="card-body">
        <table class="table" style="width: 100%">
          <thead>
            <tr>
              <th scope="col">Description</th>
              <th scope="col">Category</th>
              <th scope="col">Quantity</th>
              <th scope="col">Units</th>
              <th scope="col">% Clients</th>
              <th scope="col">% Animal Feed</th>
              <th scope="col">% Compost</th>
              <th scope="col">% Partner Network</th>
              <th scope="col">% Landfill</th>
              <th scope="col"></th>

              <th scope="col"></th>
            </tr>
          </thead>
          <tbody>
            {% for i in Object %}
            <tr>

              <td>{{i.0}}</td>
              <td>{{i.1}}</td>
              <td>{{i.2}}</td>
              <td>{{i.3}}</td>
              <td>{{i.4}}</td>
              <td>{{i.5}}</td>
              <td>{{i.6}}</td>
              <td>{{i.7}}</td>
              <td>{{i.8}}</td>
              <td>
                <form action="{% url 'tracker' %}" method="post">
                  {% csrf_token %}
                  <button class="btn btn-danger" type="submit"
                    value="{{i.0}}|{{i.1}}|{{i.2}}|{{i.3}}|{{i.4}}|{{i.5}}|{{i.6}}|{{i.7}}|{{i.8}}"
                    name="field">Delete</button>

                </form>

              </td>

            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <br />

  <div id="penetrate" class="penetrate"></div>
  {{ json|json_script:"json" }}
  <script>
    let penetrate = document.getElementById("penetrate");
    let h3 = document.createElement("h3");
    h3.innerText = "Database Visuals";
    penetrate.appendChild(h3);

    var mydata = JSON.parse(document.getElementById("json").textContent);
    mydata = JSON.parse(mydata);
    mydata = JSON.parse(JSON.stringify(mydata));
    mydata.forEach((val) => console.log(val.Category)); //print by field
    console.log(mydata); // print whole object

    var sum = mydata.reduce((n, { Quantity }) => n + Quantity, 0);
    console.log(sum);

    var result = Array.from(mydata.reduce(
      (acc, obj) => Object.keys(obj).reduce(
        (acc, key) => typeof obj[key] == "number"
          ? acc.set(key, (acc.get(key) || []).concat(obj[key]))
          : acc,
        acc),
      new Map()),
      ([name, values]) =>
        ({ name, average: values.reduce((a, b) => a + b) / sum * 100 })
    );
    console.log(result);

    let mycategory = mydata[0].Category;
    let myclients = result[1].average.toFixed(2);
    let myfeeds = result[2].average.toFixed(2);
    let mycompost = result[3].average.toFixed(2);
    let mypartners = result[4].average.toFixed(2);
    let mylandfill = result[5].average.toFixed(2);

    let thedata = [
      { category: "Clients", number: myclients },
      { category: "Animal Feed", number: myfeeds },
      { category: "Compost / Fertilizer", number: mycompost },
      { category: "Partner Network", number: mypartners },
      { category: "Landfill", number: mylandfill },
    ];

    let width = 750,
      height = 500;

    let colors = d3.scaleOrdinal(d3.schemeDark2);

    let svg = d3
      .select("body")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .style("background", "#e7f5e4");

    let data = d3
      .pie()
      .sort(null)
      .value(function (d) {
        return d.number;
      })(thedata);

    let segments = d3
      .arc()
      .innerRadius(0)
      .outerRadius(200)
      .padAngle(0.05)
      .padRadius(50);

    let sections = svg
      .append("g")
      .attr("transform", "translate(250, 250)")
      .selectAll("path")
      .data(data);

    sections
      .enter()
      .append("path")
      .attr("d", segments)
      .attr("fill", function (d) {
        return colors(d.data.category);
      });

    let content = d3.select("g").selectAll("text").data(data);

    content
      .enter()
      .append("text")
      .classed("inside", true)
      .each(function (d) {
        let center = segments.centroid(d);
        d3.select(this)
          .attr("x", center[0])
          .attr("y", center[1])
          .text(`${d.data.category}:\n${d.data.number}`)
          .style("text-anchor", "middle");
      });

    let legends = svg
      .append("g")
      .attr("transform", "translate(500, 100)")
      .selectAll(".legends")
      .data(data);

    let legend = legends
      .enter()
      .append("g")
      .classed("legends", true)
      .attr("transform", function (d, i) {
        return "translate(0," + (i + 1) * 30 + ")";
      });

    legend
      .append("rect")
      .attr("width", 20)
      .attr("height", 20)
      .attr("fill", function (d) {
        return colors(d.data.category);
      });

    legend
      .append("text")
      .classed("label", true)
      .text(function (d) {
        return d.data.category;
      })
      .attr("fill", function (d) {
        return colors(d.data.category);
      })
      .attr("x", 30)
      .attr("y", 15);
    //   console.log(`Hey my category is: ${mydata[0].Category}`);
    //   for (let i = 0; i < mydata.length; i++) console.log(mydata[i].DivertAFeed);
  </script>
</div>

<script src="{% static 'postlogin/js/tracker.js'%}"></script>
{% endblock content%}